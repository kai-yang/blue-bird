module quadratures
  use global_com,only:dp
  implicit none
  save
  real(kind=dp),allocatable,dimension(:)::qp_s,wght_s,qp_t,wght_t
  integer::nqp_s,nqp_t !source,test
  ! surface quadratures
  integer::combined_maxqp,total_maxqp_t
contains
  subroutine determine_quadrature
    ! surface qudrature rules
    ! sets the quadrature rules for the source and test triangles.
    ! mostly based on the paper by D. A. Dunavant, "High degree efficient
    ! symmetrical gaussian quadrature rules for the triangle," 1985.
    integer::j,qrule(2)
    real(kind=dp),allocatable,dimension(:)::qp_p,wght_p

    qrule(1:2)=(/nqp_s,nqp_t/)
    do j=1,2
       allocate(qp_p(qrule(j)),wght_p(qrule(j)))
       select case(qrule(j))
       case(1)
          qp_p(1)=0.5d0
          wght_p(1)=1.0d0
       case(2)
          qp_p(1:2)=(/0.211324865405187d0,0.788675134594813d0/)
          wght_p(1:2)=(/0.5d0,0.5d0/)
       case(3)
          qp_p(1:3)=(/0.5d0,0.112701665379258d0,0.887298334620742d0/)
          wght_p(1:3) = (/0.444444444444444d0,0.277777777777776d0,&
               0.277777777777776d0/)
       case(4)
          qp_p(1:4)= (/0.330009478207572d0,6.943184420297372d-2,&
               0.669990521792428d0,0.930568155797026d0/)
          wght_p(1:4)=(/0.326072577431273d0,0.173927422568727d0,&
               0.326072577431273d0,0.173927422568727d0/)
       case(5)
          qp_p(1:5)=(/0.5d0,4.691007703066802d-2,0.230765344947158d0,&
               0.769234655052841d0,0.953089922969332d0/)
          wght_p(1:5)=(/0.284444444444444d0,0.118463442528095d0,&
               0.239314335249683d0,0.239314335249683d0,&
               0.118463442528095d0/)
       case(6)
          qp_p(1:6)=(/0.619309593041598d0,3.376524289842397d-2,&
               0.169395306766868d0,0.380690406958402d0,&
               0.830604693233132d0,0.966234757101576d0/)
          wght_p(1:6)=(/0.233956967286346d0,8.566224618958525d-2,&
               0.180380786524069d0,0.233956967286346d0,&
               0.180380786524069d0,8.566224618958525d-2/)
       case(7)
          qp_p(1:7)=(/0.5d0,2.544604382862076d-2,0.129234407200303d0,&
               0.297077424311301d0,0.702922575688699d0,&
               0.870765592799697d0,0.974553956171379d0/)
          wght_p(1:7)=(/0.208979591836735d0,6.474248308443483d-2,&
               0.139852695744638d0,0.190915025252560d0,&
               0.190915025252560d0,0.139852695744638d0,&
               6.474248308443483d-2/)
       case(8)
          qp_p(1:8)=(/0.408282678752175d0,1.985507175123186d-2,&
               0.101666761293187d0,0.237233795041836d0,&
               0.591717321247825d0,0.762766204958164d0,&
               0.898333238706813d0,0.980144928248768d0/)
          wght_p(1:8)=(/0.181341891689181d0,5.061426814518839d-2,&
               0.111190517226687d0,0.156853322938944d0,&
               0.181341891689181d0,0.156853322938944d0,&
               0.111190517226687d0,5.061426814518839d-2/)
       case(9)
          qp_p(1:9)=(/0.5d0,1.591988024618696d-2,8.198444633668206d-2,&
               0.193314283649705d0,0.337873288298096d0,&
               0.662126711701904d0,0.806685716350295d0,&
               0.918015553663318d0,0.984080119753813d0/)
          wght_p(1:9)=(/0.165119677500630d0,4.063719418078731d-2,&
               9.032408034742879d-2,0.130305348201468d0,&
               0.156173538520001d0,0.156173538520001d0,&
               0.130305348201468d0,9.032408034742879d-2,&
               4.063719418078731d-2/)
       case(10)
          qp_p(1:10)=(/0.574437169490816d0,1.304673574141413d-2,&
               6.746831665550773d-2,0.160295215850488d0,&
               0.283302302935376d0,0.425562830509184d0,&
               0.716697697064624d0,0.839704784149512d0,&
               0.932531683344492d0,0.986953264258586d0/)
          wght_p(1:10)=(/0.147762112357376d0,3.333567215434186d-2,&
               7.472567457529027d-2,0.109543181257991d0,&
               0.134633359654998d0,0.147762112357376d0,&
               0.134633359654998d0,0.109543181257991d0,&
               7.472567457529027d-2,3.333567215434186d-2/)
       end select
       if (j==1) then !source qp
          allocate(qp_s(1:nqp_s),wght_s(1:nqp_s))
          qp_s=qp_p;wght_s=wght_p
       else ! j==2 !testing qp
          allocate(qp_t(1:nqp_t),wght_t(1:nqp_t))
          qp_t=qp_p;wght_t=wght_p
       end if
       deallocate(qp_p,wght_p)
    end do
  end subroutine determine_quadrature
end module quadratures
